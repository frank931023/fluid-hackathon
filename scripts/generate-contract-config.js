import fs from 'fs/promises';
import path from 'path';

// Configuration: artifact locations (relative to project root)
const ARTIFACTS = {
  USDC: 'artifacts/contracts/Mock_USDC.sol/Mock_USDC.json',
  RWA: 'artifacts/contracts/Mock_RWA_Token.sol/Mock_RWA_Token.json',
  ORACLE: 'artifacts/contracts/Mock_PriceOracle.sol/Mock_PriceOracle.json',
  POOL: 'artifacts/contracts/FluidPay_LendingPool.sol/FluidPay_LendingPool.json',
};

const OUT_FILE = 'contract-config.js';
const DEPLOYMENTS_FILE = 'deployments/local-deployment.json';

async function readAbi(file) {
  try {
    const raw = await fs.readFile(file, 'utf8');
    const json = JSON.parse(raw);
    if (!json.abi) throw new Error('no abi');
    return json.abi;
  } catch (err) {
    console.warn(`Warning: could not read ABI from ${file}: ${err.message}`);
    return null;
  }
}

async function readDeployments() {
  try {
    const raw = await fs.readFile(DEPLOYMENTS_FILE, 'utf8');
    const json = JSON.parse(raw);
    return json.contracts ?? {};
  } catch (err) {
    // missing deployments is OK
    return {};
  }
}

function exportConst(name, value) {
  return `export const ${name} = ${value};\n`;
}

async function main() {
  const abis = {};
  for (const [k, v] of Object.entries(ARTIFACTS)) {
    const p = path.resolve(v);
    const abi = await readAbi(p);
    abis[k] = abi;
  }

  const addresses = await readDeployments();

  // Build output file content
  let out = '// Auto-generated by scripts/generate-contract-config.mjs\n';
  out += "// Replace addresses if you deploy to another network.\n\n";

  out += exportConst('USDC_ADDRESS', JSON.stringify(addresses.Mock_USDC ?? ''));
  out += exportConst('RWA_TOKEN_ADDRESS', JSON.stringify(addresses.Mock_RWA_Token ?? ''));
  out += exportConst('ORACLE_ADDRESS', JSON.stringify(addresses.Mock_PriceOracle ?? ''));
  out += exportConst('LENDING_POOL_ADDRESS', JSON.stringify(addresses.FluidPay_LendingPool ?? ''));
  out += '\n';

  // ABIs
  const usdcAbiText = abis.USDC ? JSON.stringify(abis.USDC, null, 2) : '[]';
  const rwaAbiText = abis.RWA ? JSON.stringify(abis.RWA, null, 2) : '[]';
  const oracleAbiText = abis.ORACLE ? JSON.stringify(abis.ORACLE, null, 2) : '[]';
  const poolAbiText = abis.POOL ? JSON.stringify(abis.POOL, null, 2) : '[]';

  out += exportConst('USDC_ABI', usdcAbiText);
  out += exportConst('RWA_TOKEN_ABI', rwaAbiText);
  out += exportConst('ORACLE_ABI', oracleAbiText);
  out += exportConst('LENDING_POOL_ABI', poolAbiText);

  await fs.writeFile(OUT_FILE, out, 'utf8');
  console.log(`Wrote ${OUT_FILE}`);
}

main().catch((err) => {
  console.error(err);
  process.exitCode = 1;
});
